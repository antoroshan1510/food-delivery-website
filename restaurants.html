{% extends "base.html" %}

{% block title %}Restaurants - Crave Bite{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('restaurants') }}">Restaurants</a></li>
{% endblock %}

{% block content %}
<section class="restaurants-section">
    <div class="container">
        <div class="section-header">
            <h2>Discover Restaurants</h2>
            <p>Find your favorite restaurants and explore their delicious offerings</p>
        </div>
        
        <div class="restaurants-controls">
            <div class="restaurants-search">
                <input type="text" id="restaurant-search" placeholder="Search restaurants by name, cuisine, or location...">
                <button id="search-btn">üîç</button>
            </div>
            <div class="restaurants-filters">
                <select id="cuisine-filter">
                    <option value="all">All Cuisines</option>
                    <option value="indian">Indian</option>
                    <option value="italian">Italian</option>
                    <option value="chinese">Chinese</option>
                    <option value="mexican">Mexican</option>
                    <option value="american">American</option>
                </select>
                <select id="rating-filter">
                    <option value="all">Any Rating</option>
                    <option value="4.5">4.5+ Stars</option>
                    <option value="4.0">4.0+ Stars</option>
                    <option value="3.5">3.5+ Stars</option>
                </select>
                <select id="distance-filter">
                    <option value="all">Any Distance</option>
                    <option value="5">Within 5 km</option>
                    <option value="10">Within 10 km</option>
                    <option value="20">Within 20 km</option>
                </select>
            </div>
        </div>
        
        <div class="location-info" id="location-info" style="margin-bottom: 20px; display: none;">
            <p id="location-message"></p>
        </div>
        
        <div class="restaurants-grid" id="restaurants-container">
            <!-- Restaurant cards will be dynamically loaded here -->
            <div class="loading" id="loading">Loading restaurants...</div>
        </div>
        
        <div class="no-results" id="no-results" style="display: none;">
            <h3>No restaurants found</h3>
            <p>Try adjusting your search criteria</p>
        </div>
    </div>
</section>

<script>
// User's current location (will be updated when geolocation is available)
let userLocation = null;
let restaurants = []; // Will be populated with real data from the server

// Function to calculate distance between two points using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c; // Distance in kilometers
    return distance;
}

// Function to fetch restaurants from the server
async function fetchRestaurants() {
    const loadingElement = document.getElementById('loading');
    loadingElement.style.display = 'block';
    
    try {
        // In a real implementation, this would fetch from an API endpoint
        // For now, we'll simulate fetching real data
        const response = await fetch('/api/restaurants');
        
        if (response.ok) {
            restaurants = await response.json();
        } else {
            // Fallback to sample data if API is not available
            console.warn('API not available, using sample data');
            restaurants = [
                {
                    id: 1,
                    name: "Taste of India",
                    cuisine: "Indian",
                    rating: 4.7,
                    deliveryTime: "25-35 min",
                    image: "https://images.unsplash.com/photo-1585853340472-1bf780c78a2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Authentic Indian cuisine with traditional spices and flavors",
                    location: "Downtown",
                    coordinates: { lat: 40.7128, lng: -74.0060 } // New York City
                },
                {
                    id: 2,
                    name: "Mamma Mia Italian",
                    cuisine: "Italian",
                    rating: 4.5,
                    deliveryTime: "30-40 min",
                    image: "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Handcrafted pasta and wood-fired pizzas",
                    location: "Midtown",
                    coordinates: { lat: 40.7589, lng: -73.9851 } // Times Square
                },
                {
                    id: 3,
                    name: "Dragon Palace",
                    cuisine: "Chinese",
                    rating: 4.3,
                    deliveryTime: "20-30 min",
                    image: "https://images.unsplash.com/photo-1592861956120-e524fc739aa7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Traditional Chinese dishes with modern twists",
                    location: "Chinatown",
                    coordinates: { lat: 40.7158, lng: -73.9976 } // Chinatown, NYC
                },
                {
                    id: 4,
                    name: "Taco Fiesta",
                    cuisine: "Mexican",
                    rating: 4.6,
                    deliveryTime: "15-25 min",
                    image: "https://images.unsplash.com/photo-1599044730851-ef6d1f3f8a53?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Fresh tacos, burritos, and authentic Mexican street food",
                    location: "Westside",
                    coordinates: { lat: 40.7831, lng: -73.9712 } // Upper West Side
                },
                {
                    id: 5,
                    name: "Burger Junction",
                    cuisine: "American",
                    rating: 4.4,
                    deliveryTime: "20-30 min",
                    image: "https://images.unsplash.com/photo-1550547660-9be5b3c4f2d9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Gourmet burgers made with locally sourced ingredients",
                    location: "Uptown",
                    coordinates: { lat: 40.7851, lng: -73.9683 } // Upper East Side
                },
                {
                    id: 6,
                    name: "Sushi Zen",
                    cuisine: "Japanese",
                    rating: 4.8,
                    deliveryTime: "35-45 min",
                    image: "https://images.unsplash.com/photo-1617196034796-73dfa7b1fd56?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                    description: "Fresh sushi and traditional Japanese dishes",
                    location: "Eastside",
                    coordinates: { lat: 40.7282, lng: -73.9942 } // East Village
                }
            ];
        }
    } catch (error) {
        console.error('Error fetching restaurants:', error);
        // Fallback to sample data on error
        restaurants = [
            {
                id: 1,
                name: "Taste of India",
                cuisine: "Indian",
                rating: 4.7,
                deliveryTime: "25-35 min",
                image: "https://images.unsplash.com/photo-1585853340472-1bf780c78a2d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Authentic Indian cuisine with traditional spices and flavors",
                location: "Downtown",
                coordinates: { lat: 40.7128, lng: -74.0060 }
            },
            {
                id: 2,
                name: "Mamma Mia Italian",
                cuisine: "Italian",
                rating: 4.5,
                deliveryTime: "30-40 min",
                image: "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Handcrafted pasta and wood-fired pizzas",
                location: "Midtown",
                coordinates: { lat: 40.7589, lng: -73.9851 }
            },
            {
                id: 3,
                name: "Dragon Palace",
                cuisine: "Chinese",
                rating: 4.3,
                deliveryTime: "20-30 min",
                image: "https://images.unsplash.com/photo-1592861956120-e524fc739aa7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Traditional Chinese dishes with modern twists",
                location: "Chinatown",
                coordinates: { lat: 40.7158, lng: -73.9976 }
            },
            {
                id: 4,
                name: "Taco Fiesta",
                cuisine: "Mexican",
                rating: 4.6,
                deliveryTime: "15-25 min",
                image: "https://images.unsplash.com/photo-1599044730851-ef6d1f3f8a53?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Fresh tacos, burritos, and authentic Mexican street food",
                location: "Westside",
                coordinates: { lat: 40.7831, lng: -73.9712 }
            },
            {
                id: 5,
                name: "Burger Junction",
                cuisine: "American",
                rating: 4.4,
                deliveryTime: "20-30 min",
                image: "https://images.unsplash.com/photo-1550547660-9be5b3c4f2d9?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Gourmet burgers made with locally sourced ingredients",
                location: "Uptown",
                coordinates: { lat: 40.7851, lng: -73.9683 }
            },
            {
                id: 6,
                name: "Sushi Zen",
                cuisine: "Japanese",
                rating: 4.8,
                deliveryTime: "35-45 min",
                image: "https://images.unsplash.com/photo-1617196034796-73dfa7b1fd56?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80",
                description: "Fresh sushi and traditional Japanese dishes",
                location: "Eastside",
                coordinates: { lat: 40.7282, lng: -73.9942 }
            }
        ];
    } finally {
        loadingElement.style.display = 'none';
        filterRestaurants();
    }
}

// Function to render restaurant cards
function renderRestaurants(restaurantsToShow) {
    const container = document.getElementById('restaurants-container');
    const noResults = document.getElementById('no-results');
    const loadingElement = document.getElementById('loading');
    
    // Hide loading indicator
    loadingElement.style.display = 'none';
    
    if (restaurantsToShow.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    container.innerHTML = restaurantsToShow.map(restaurant => {
        // Calculate distance if user location is available
        let distanceInfo = '';
        if (userLocation && restaurant.coordinates) {
            const distance = calculateDistance(
                userLocation.lat, 
                userLocation.lng, 
                restaurant.coordinates.lat, 
                restaurant.coordinates.lng
            );
            distanceInfo = `<span class="distance">üìç ${distance.toFixed(1)} km away</span>`;
        }
        
        return `
        <div class="restaurant-card" data-id="${restaurant.id}">
            <div class="restaurant-image">
                <img src="${restaurant.image}" alt="${restaurant.name}">
                <div class="restaurant-rating">
                    <span>‚òÖ ${restaurant.rating}</span>
                </div>
            </div>
            <div class="restaurant-info">
                <h3>${restaurant.name}</h3>
                <p class="restaurant-cuisine">${restaurant.cuisine}</p>
                <p class="restaurant-description">${restaurant.description}</p>
                <div class="restaurant-meta">
                    <span class="delivery-time">‚è±Ô∏è ${restaurant.deliveryTime}</span>
                    <span class="location">üìç ${restaurant.location}</span>
                    ${distanceInfo}
                </div>
                <a href="/restaurant/${restaurant.id}" class="btn btn-primary">View Menu</a>
            </div>
        </div>
    `;
    }).join('');
}

// Function to filter restaurants based on search and filters
function filterRestaurants() {
    const searchTerm = document.getElementById('restaurant-search').value.toLowerCase();
    const cuisineFilter = document.getElementById('cuisine-filter').value;
    const ratingFilter = document.getElementById('rating-filter').value;
    const distanceFilter = document.getElementById('distance-filter').value;
    
    const filtered = restaurants.filter(restaurant => {
        // Text-based search
        const matchesSearch = restaurant.name.toLowerCase().includes(searchTerm) || 
                             restaurant.cuisine.toLowerCase().includes(searchTerm) ||
                             restaurant.description.toLowerCase().includes(searchTerm) ||
                             restaurant.location.toLowerCase().includes(searchTerm);
        
        const matchesCuisine = cuisineFilter === 'all' || restaurant.cuisine.toLowerCase() === cuisineFilter;
        
        const matchesRating = ratingFilter === 'all' || restaurant.rating >= parseFloat(ratingFilter);
        
        // Distance-based filter
        let matchesDistance = true;
        if (userLocation && distanceFilter !== 'all' && restaurant.coordinates) {
            const distance = calculateDistance(
                userLocation.lat, 
                userLocation.lng, 
                restaurant.coordinates.lat, 
                restaurant.coordinates.lng
            );
            matchesDistance = distance <= parseFloat(distanceFilter);
        }
        
        return matchesSearch && matchesCuisine && matchesRating && matchesDistance;
    });
    
    renderRestaurants(filtered);
}

// Function to get user's current location
function getUserLocation() {
    const locationInfo = document.getElementById('location-info');
    const locationMessage = document.getElementById('location-message');
    
    if (navigator.geolocation) {
        locationInfo.style.display = 'block';
        locationMessage.textContent = 'Getting your location...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                locationMessage.textContent = `Your location detected. Showing restaurants near you.`;
                // Re-filter restaurants with the new location
                filterRestaurants();
            },
            function(error) {
                console.error('Error getting location:', error);
                locationMessage.textContent = 'Unable to get your location. Showing all restaurants.';
                locationInfo.style.display = 'none';
            }
        );
    } else {
        locationMessage.textContent = 'Geolocation is not supported by this browser.';
        locationInfo.style.display = 'none';
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Check for search query parameter and apply filter
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('search');
    if (searchQuery) {
        const searchInput = document.getElementById('restaurant-search');
        if (searchInput) {
            searchInput.value = searchQuery;
        }
    }
    
    // Try to get user's location
    getUserLocation();
    
    // Fetch real restaurant data
    fetchRestaurants();
    
    // Add event listeners
    document.getElementById('restaurant-search').addEventListener('input', filterRestaurants);
    document.getElementById('cuisine-filter').addEventListener('change', filterRestaurants);
    document.getElementById('rating-filter').addEventListener('change', filterRestaurants);
    document.getElementById('distance-filter').addEventListener('change', filterRestaurants);
    document.getElementById('search-btn').addEventListener('click', filterRestaurants);
    
    // Allow Enter key to trigger search
    document.getElementById('restaurant-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterRestaurants();
        }
    });
});
</script>

<style>
.restaurants-section {
    padding: 40px 0;
}

.section-header {
    text-align: center;
    margin-bottom: 40px;
}

.section-header h2 {
    font-size: 2.5rem;
    color: #0a3d2f;
    margin-bottom: 15px;
}

.section-header p {
    font-size: 1.1rem;
    color: #666;
    max-width: 600px;
    margin: 0 auto;
}

.restaurants-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: space-between;
    align-items: center;
}

.restaurants-search {
    display: flex;
    flex: 1;
    max-width: 500px;
}

.restaurants-search input {
    flex: 1;
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px 0 0 8px;
    font-size: 1rem;
    outline: none;
}

.restaurants-search input:focus {
    border-color: #0a3d2f;
}

.restaurants-search button {
    background: #0a3d2f;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    font-size: 1.2rem;
    transition: background 0.3s;
}

.restaurants-search button:hover {
    background: #146b52;
}

.restaurants-filters {
    display: flex;
    gap: 15px;
}

.restaurants-filters select {
    padding: 12px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
    outline: none;
}

.restaurants-filters select:focus {
    border-color: #0a3d2f;
}

.location-info {
    background: #e8f4f1;
    padding: 10px 15px;
    border-radius: 8px;
    text-align: center;
    color: #0a3d2f;
}

.restaurants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 30px;
    margin-top: 20px;
}

.restaurant-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.restaurant-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.restaurant-image {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.restaurant-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s;
}

.restaurant-card:hover .restaurant-image img {
    transform: scale(1.05);
}

.restaurant-rating {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
    color: #0a3d2f;
}

.restaurant-info {
    padding: 20px;
}

.restaurant-info h3 {
    margin: 0 0 10px 0;
    color: #0a3d2f;
    font-size: 1.4rem;
}

.restaurant-cuisine {
    color: #146b52;
    font-weight: 600;
    margin: 0 0 10px 0;
}

.restaurant-description {
    color: #666;
    margin: 0 0 15px 0;
    line-height: 1.5;
}

.restaurant-meta {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 20px;
    font-size: 0.9rem;
    color: #888;
}

.restaurant-meta .delivery-time, .restaurant-meta .location, .restaurant-meta .distance {
    display: block;
}

.btn-primary {
    display: inline-block;
    background: #0a3d2f;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    text-align: center;
    transition: background 0.3s;
    border: none;
    cursor: pointer;
    width: 100%;
}

.btn-primary:hover {
    background: #146b52;
}

.loading {
    text-align: center;
    padding: 40px;
    font-size: 1.2rem;
    color: #666;
}

.no-results {
    text-align: center;
    padding: 60px 20px;
}

.no-results h3 {
    color: #0a3d2f;
    margin-bottom: 15px;
}

.no-results p {
    color: #666;
}

@media (max-width: 768px) {
    .restaurants-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .restaurants-search {
        max-width: 100%;
    }
    
    .restaurants-filters {
        width: 100%;
        flex-wrap: wrap;
    }
    
    .restaurants-filters select {
        flex: 1;
        min-width: 120px;
    }
    
    .restaurants-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}